import { React, css, html } from '../utils/webModules.js';
import { useStateValue } from '../utils/globalState.js';

import LoadingBar from './LoadingBar.js';

const LoginPage = ({ setGithubAccessToken }) => {
  const [state, dispatch] = useStateValue();
  const { githubAccessToken } = state;
  const [loading, setLoading] = React.useState(false);
  const loginWindow = React.useRef(null);

  const sendTemporaryAccessToken = temporaryAccessToken => {
    setLoading(true);
    loginWindow.current && loginWindow.current.close();
    fetch(
      `https://glu-auth.now.sh/api/auth?access_token=${temporaryAccessToken}&redirect_uri=${window.location.origin}`
    )
      .then(res => res.json())
      .then(({ access_token }) => {
        if (access_token) {
          setLoading(false);
          dispatch({ type: 'setGithubAccessToken', payload: access_token });
        }
      });
  };

  const login = () => {
    loginWindow.current = window.open(
      `https://github.com/login/oauth/authorize?client_id=75c2947e81bbde1e3882&scope=read:user%20repo&redirect_uri=${window.location.origin}&state=glu`,
      '_blank',
      'height=635,width=623,toolbar=0,location=0,menubar=0'
    );
    window.sendTemporaryAccessToken = sendTemporaryAccessToken;
  };

  return html`
    <div className=${style.container}>
      <div className=${style.loadingBarWrapper}>
        <${LoadingBar}
          active=${loading}
          loading=${{
            indeterminate: true
          }}
        />
      </div>
      <svg
        class=${style.illustration}
        viewBox="0 0 1014 503"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <g clip-path="url(#clip0)">
          <path
            d="M506.975 0C228.302 0 2.15067 224.834 0 503H1013.95C1011.8 224.834 785.648 0 506.975 0Z"
            fill="#191919"
          />
          <path
            d="M480.788 57.5439C483.549 57.5439 485.788 55.3054 485.788 52.5439C485.788 49.7825 483.549 47.5439 480.788 47.5439C478.026 47.5439 475.788 49.7825 475.788 52.5439C475.788 55.3054 478.026 57.5439 480.788 57.5439Z"
            fill="#F2F2F2"
          />
          <path
            d="M323.788 219.544C324.892 219.544 325.788 218.649 325.788 217.544C325.788 216.439 324.892 215.544 323.788 215.544C322.683 215.544 321.788 216.439 321.788 217.544C321.788 218.649 322.683 219.544 323.788 219.544Z"
            fill="#F2F2F2"
          />
          <path
            d="M618.788 313.544C619.892 313.544 620.788 312.649 620.788 311.544C620.788 310.439 619.892 309.544 618.788 309.544C617.683 309.544 616.788 310.439 616.788 311.544C616.788 312.649 617.683 313.544 618.788 313.544Z"
            fill="#F2F2F2"
          />
          <path
            d="M97.7876 288.544C98.8922 288.544 99.7876 287.649 99.7876 286.544C99.7876 285.439 98.8922 284.544 97.7876 284.544C96.683 284.544 95.7876 285.439 95.7876 286.544C95.7876 287.649 96.683 288.544 97.7876 288.544Z"
            fill="#F2F2F2"
          />
          <path
            d="M877.788 217.544C878.892 217.544 879.788 216.649 879.788 215.544C879.788 214.439 878.892 213.544 877.788 213.544C876.683 213.544 875.788 214.439 875.788 215.544C875.788 216.649 876.683 217.544 877.788 217.544Z"
            fill="#F2F2F2"
          />
          <path
            d="M235.788 238.544C236.892 238.544 237.788 237.649 237.788 236.544C237.788 235.439 236.892 234.544 235.788 234.544C234.683 234.544 233.788 235.439 233.788 236.544C233.788 237.649 234.683 238.544 235.788 238.544Z"
            fill="#F2F2F2"
          />
          <path
            d="M563.788 198.544C564.892 198.544 565.788 197.649 565.788 196.544C565.788 195.439 564.892 194.544 563.788 194.544C562.683 194.544 561.788 195.439 561.788 196.544C561.788 197.649 562.683 198.544 563.788 198.544Z"
            fill="#F2F2F2"
          />
          <path
            d="M629.788 54.5439C630.892 54.5439 631.788 53.6485 631.788 52.5439C631.788 51.4394 630.892 50.5439 629.788 50.5439C628.683 50.5439 627.788 51.4394 627.788 52.5439C627.788 53.6485 628.683 54.5439 629.788 54.5439Z"
            fill="#F2F2F2"
          />
          <path
            d="M213.788 288.544H211.788V289.544H213.788V288.544Z"
            fill="#F2F2F2"
          />
          <path
            d="M272.788 135.544H270.788V136.544H272.788V135.544Z"
            fill="#F2F2F2"
          />
          <path
            d="M416.788 249.544H414.788V250.544H416.788V249.544Z"
            fill="#F2F2F2"
          />
          <path
            d="M798.788 293.544H796.788V294.544H798.788V293.544Z"
            fill="#F2F2F2"
          />
          <path
            d="M679.788 140.544H677.788V141.544H679.788V140.544Z"
            fill="#F2F2F2"
          />
          <path
            d="M228.608 363.68H225.089V502.683H228.608V363.68Z"
            fill="#333333"
          />
          <path
            d="M261.085 339.394C261.309 388 227.112 427.562 227.112 427.562C227.112 427.562 192.552 388.317 192.328 339.711C192.104 291.105 226.301 251.544 226.301 251.544C226.301 251.544 260.861 290.788 261.085 339.394Z"
            fill="#333333"
          />
          <path
            d="M185.172 322.472H180.61V502.683H185.172V322.472Z"
            fill="#333333"
          />
          <path
            d="M227.277 303.438C227.567 366.453 183.233 417.743 183.233 417.743C183.233 417.743 138.427 366.864 138.137 303.849C137.846 240.833 182.181 189.544 182.181 189.544C182.181 189.544 226.986 240.423 227.277 303.438Z"
            fill="#333333"
          />
          <path
            d="M715.608 363.68H712.089V502.683H715.608V363.68Z"
            fill="#828282"
          />
          <path
            d="M748.085 381.394C748.309 430 714.112 469.562 714.112 469.562C714.112 469.562 679.552 430.317 679.328 381.711C679.104 333.105 713.301 293.544 713.301 293.544C713.301 293.544 747.861 332.788 748.085 381.394Z"
            fill="#333333"
          />
          <path
            d="M144.608 363.68H141.089V502.683H144.608V363.68Z"
            fill="#333333"
          />
          <path
            d="M177.085 339.394C177.309 388 143.112 427.562 143.112 427.562C143.112 427.562 108.552 388.317 108.328 339.711C108.104 291.105 142.301 251.544 142.301 251.544C142.301 251.544 176.861 290.788 177.085 339.394Z"
            fill="#333333"
          />
          <path
            d="M454.608 363.68H451.089V502.683H454.608V363.68Z"
            fill="#333333"
          />
          <path
            d="M487.085 339.394C487.309 388 453.112 427.562 453.112 427.562C453.112 427.562 418.552 388.317 418.328 339.711C418.104 291.105 452.301 251.544 452.301 251.544C452.301 251.544 486.861 290.788 487.085 339.394Z"
            fill="#333333"
          />
          <path
            d="M411.172 322.472H406.61V502.683H411.172V322.472Z"
            fill="#333333"
          />
          <path
            d="M453.277 303.438C453.567 366.453 409.233 417.743 409.233 417.743C409.233 417.743 364.427 366.864 364.137 303.849C363.846 240.833 408.181 189.544 408.181 189.544C408.181 189.544 452.986 240.423 453.277 303.438Z"
            fill="#333333"
          />
          <path
            d="M370.608 363.68H367.089V502.683H370.608V363.68Z"
            fill="#333333"
          />
          <path
            d="M403.085 339.394C403.309 388 369.112 427.562 369.112 427.562C369.112 427.562 334.552 388.317 334.328 339.711C334.104 291.105 368.301 251.544 368.301 251.544C368.301 251.544 402.861 290.788 403.085 339.394Z"
            fill="#333333"
          />
          <path
            d="M738.362 428.413L679.558 374.345C679.399 376.774 679.317 379.23 679.328 381.711C679.552 430.317 714.112 469.562 714.112 469.562C724.174 457.112 732.345 443.247 738.362 428.413V428.413Z"
            fill="#828282"
          />
          <path
            d="M300.644 490.284C302.658 497.732 309.559 502.344 309.559 502.344C309.559 502.344 313.194 494.882 311.179 487.434C309.164 479.986 302.263 475.374 302.263 475.374C302.263 475.374 298.629 482.836 300.644 490.284Z"
            fill="#333333"
          />
          <path
            d="M303.604 488.683C309.133 494.065 309.808 502.338 309.808 502.338C309.808 502.338 301.52 501.886 295.991 496.504C290.463 491.122 289.788 482.849 289.788 482.849C289.788 482.849 298.076 483.302 303.604 488.683Z"
            fill="#333333"
          />
          <path
            d="M584.644 490.284C586.658 497.732 593.559 502.344 593.559 502.344C593.559 502.344 597.194 494.882 595.179 487.434C593.164 479.986 586.263 475.374 586.263 475.374C586.263 475.374 582.629 482.836 584.644 490.284Z"
            fill="#828282"
          />
          <path
            d="M587.604 488.683C593.133 494.065 593.808 502.338 593.808 502.338C593.808 502.338 585.52 501.886 579.991 496.504C574.463 491.122 573.788 482.849 573.788 482.849C573.788 482.849 582.076 483.302 587.604 488.683Z"
            fill="#828282"
          />
          <path
            d="M76.6436 490.284C78.6583 497.732 85.5593 502.344 85.5593 502.344C85.5593 502.344 89.1937 494.882 87.179 487.434C85.1642 479.986 78.2633 475.374 78.2633 475.374C78.2633 475.374 74.6288 482.836 76.6436 490.284Z"
            fill="#333333"
          />
          <path
            d="M79.6043 488.683C85.1328 494.065 85.8081 502.338 85.8081 502.338C85.8081 502.338 77.5199 501.886 71.9914 496.504C66.4629 491.122 65.7876 482.849 65.7876 482.849C65.7876 482.849 74.0758 483.302 79.6043 488.683Z"
            fill="#333333"
          />
          <path
            d="M387.333 220.707L483.843 366.369C485.999 357.54 487.088 348.483 487.086 339.394C486.976 315.692 478.702 294.219 470.252 278.434L465.788 279.544L469.987 277.942C465.011 268.56 459.085 259.715 452.302 251.544C452.302 251.544 449.839 254.394 446.242 259.499C433.562 218.37 408.181 189.544 408.181 189.544C400.259 199.247 393.278 209.682 387.333 220.707V220.707Z"
            fill="#828282"
          />
          <path
            d="M896.669 494.549C896.719 494.595 896.767 494.641 896.818 494.685C896.781 494.631 896.74 494.58 896.707 494.524L896.669 494.549Z"
            fill="#56CCF2"
          />
          <path
            opacity="0.1"
            d="M574.728 277.957L574.727 277.956L552.908 257.894L552.712 257.943L543.975 250L543.553 249.877L544.008 249.704L451.089 164.271L361.353 81.7622L315.628 106.016L311.888 106.844L366.685 189.544L574.068 502.544H818.988L574.728 277.957Z"
            fill="#F2F2F2"
          />
          <path
            d="M334.788 119.544C349.699 119.544 361.788 107.456 361.788 92.5439C361.788 77.6323 349.699 65.5439 334.788 65.5439C319.876 65.5439 307.788 77.6323 307.788 92.5439C307.788 107.456 319.876 119.544 334.788 119.544Z"
            fill="#F2F2F2"
          />
        </g>
        <defs>
          <clipPath id="clip0">
            <rect width="1013.95" height="503" fill="white" />
          </clipPath>
        </defs>
      </svg>
      <div>
        <h1>Getting Started</h1>
        <p>
          To manage apps with the launcher we'll need you to authenticate. This
          allows you to perform operations like creating and publishing new
          projects.
        </p>
      </div>
      <button className=${style.button} onClick=${login}>
        <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <title>GitHub icon</title>
          <path
            d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"
          />
        </svg>
        <span>Login with Github</span>
      </button>
    </div>
  `;
};

const style = {
  container: css`
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100vw;
    height: 100vh;
    padding: 3rem;
    > * + * {
      margin-top: 2rem;
    }

    h1 {
      text-align: center;
      margin-bottom: 1.38rem;
    }

    p {
      line-height: 162%;
      text-align: center;
      max-width: 50ch;
      color: rgba(255, 255, 255, 0.38);
    }
  `,
  illustration: css`
    width: 100%;
    max-width: 20rem;
  `,
  loadingBarWrapper: css`
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
  `,
  button: css`
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    border: 0;
    background: rgba(0, 0, 0, 0.1);
    color: #fff;
    padding: 1rem;
    font-size: 1rem;
    box-shadow: 0 4px 0 0 rgba(0, 0, 0, 0.2);
    transition: box-shadow 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    border-radius: 0.5rem;
    opacity: 0.62;
    transition: transform 0.3s, opacity 0.2s, box-shadow 0.2s;

    > * + * {
      margin-left: 1rem;
    }

    :hover {
      box-shadow: 0 6px 0 0 rgba(0, 0, 0, 0.18);
      transform: translate(0, -3px);
      opacity: 1;
    }
    :active {
      box-shadow: 0 2px 0 0 rgba(0, 0, 0, 0.2);
      transform: translate(0, 0);
    }

    svg {
      width: 1.38rem;
      height: 1.38rem;
      fill: #fff;
    }
  `
};

export default LoginPage;
